#!/usr/bin/env bash
# tmux-nix-finder: Find shell.nix and flake.nix files and open them in tmux sessions with nix-shell or nix develop

set -o pipefail

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/tmux-nix-finder"
CONFIG_FILE="$CONFIG_DIR/config"

# Default search paths if not configured
SEARCH_PATHS=("$HOME")

# Default max depth for finding shell.nix files
MAX_DEPTH=3

# Default shell command to run in nix-shell (can be overridden in config)
NIX_SHELL_COMMAND=""

# Check for required dependencies
check_dependencies() {
    local missing=()
    
    for cmd in fzf tmux nix-shell; do
        if ! command -v "$cmd" &> /dev/null; then
            missing+=("$cmd")
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "Error: Missing required dependencies: ${missing[*]}" >&2
        exit 1
    fi
}

# Load configuration
load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        # shellcheck disable=SC1090
        source "$CONFIG_FILE"
    fi
}

# Find all shell.nix and flake.nix files in configured paths
find_nix_shells() {
    for path in "${SEARCH_PATHS[@]}"; do
        # Expand path
        local expanded_path="${path/#\~/$HOME}"
        
        if [[ -d "$expanded_path" ]]; then
            # Find shell.nix and flake.nix files and output their parent directories
            find "$expanded_path" -maxdepth "$MAX_DEPTH" -type f \( -name "shell.nix" -o -name "flake.nix" \) -printf '%h\n' 2>/dev/null
        fi
    done | awk '!seen[$0]++'  # Remove duplicates while preserving streaming
}

# Determine which nix command to use for a directory
# Prefers flake.nix if both exist
get_nix_command() {
    local dir="$1"
    
    if [[ -f "$dir/flake.nix" ]]; then
        echo "nix develop"
    elif [[ -f "$dir/shell.nix" ]]; then
        echo "nix-shell"
    else
        # Fallback to nix-shell if no file found (shouldn't happen)
        echo "nix-shell"
    fi
}

# Create or switch to tmux session for the selected directory
open_session() {
    local selected="$1"
    
    if [[ -z "$selected" ]]; then
        exit 0
    fi
    
    # Create session name from path:
    # 1. Remove $HOME prefix
    # 2. Remove leading slash
    # 3. Replace dots with underscores (tmux doesn't like dots in session names)
    local session_name
    session_name=$(echo "$selected" | sed "s@$HOME@@; s@^/@@; s@\.@_@g")
    
    # Determine which nix command to use
    local nix_cmd
    nix_cmd=$(get_nix_command "$selected")
    
    # Check if session already exists
    if tmux has-session -t="$session_name" 2>/dev/null; then
        # Session exists, switch to it
        if [[ -n "$TMUX" ]]; then
            tmux switch-client -t "$session_name"
        else
            tmux attach-session -t "$session_name"
        fi
    else
        # Create new session with appropriate nix command
        if [[ -n "$NIX_SHELL_COMMAND" ]]; then
            # Run nix command with custom shell
            # nix-shell uses --run, nix develop uses --command
            if [[ "$nix_cmd" == "nix develop" ]]; then
                tmux new-session -d -s "$session_name" -c "$selected" nix develop --command "$NIX_SHELL_COMMAND"
            else
                tmux new-session -d -s "$session_name" -c "$selected" nix-shell --run "$NIX_SHELL_COMMAND"
            fi
        else
            # Run nix command with default behavior
            if [[ "$nix_cmd" == "nix develop" ]]; then
                tmux new-session -d -s "$session_name" -c "$selected" nix develop
            else
                tmux new-session -d -s "$session_name" -c "$selected" nix-shell
            fi
        fi
        
        if [[ -n "$TMUX" ]]; then
            tmux switch-client -t "$session_name"
        else
            tmux attach-session -t "$session_name"
        fi
    fi
}

# Show help
show_help() {
    cat << EOF
tmux-nix-finder - Find shell.nix and flake.nix files and open them in tmux sessions

Usage: tmux-nix-finder [OPTIONS]

Options:
    -h, --help      Show this help message
    -l, --list      List all nix project directories without opening

Configuration:
    Config file: $CONFIG_FILE
    
    The config file allows you to configure:
    - SEARCH_PATHS: Array of directories to search for nix files
    - MAX_DEPTH: Maximum depth to search (default: 3)
    - NIX_SHELL_COMMAND: Optional command to run in nix-shell/nix develop (e.g., "zsh" or "bash")

Example config:
    SEARCH_PATHS=("\$HOME/projects" "\$HOME/work")
    MAX_DEPTH=4
    NIX_SHELL_COMMAND="zsh"

How it works:
    - Searches for shell.nix and flake.nix files
    - Uses 'nix develop' for flake.nix (preferred if both exist)
    - Uses 'nix-shell' for shell.nix
    - Creates or switches to a tmux session for the selected directory

Examples:
    tmux-nix-finder              # Interactive nix project selection
    tmux-nix-finder --list       # List all nix project directories

EOF
}

# Main function
main() {
    load_config
    check_dependencies
    
    # Stream shell.nix directories directly to fzf for immediate display
    local selected
    selected=$(find_nix_shells | fzf --tmux=center,100% --prompt="NIX it up: ")
    
    open_session "$selected"
}

# Parse command line arguments
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    -l|--list)
        load_config
        find_nix_shells | sort -u
        exit 0
        ;;
    "")
        main
        ;;
    *)
        echo "Error: Unknown option: $1" >&2
        show_help
        exit 1
        ;;
esac
