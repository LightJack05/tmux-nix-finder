#!/usr/bin/env bash
# tmux-nix-finder: Find shell.nix files and open them in tmux sessions with nix-shell

set -o pipefail

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/tmux-nix-finder"
CONFIG_FILE="$CONFIG_DIR/config"

# Default search paths if not configured
SEARCH_PATHS=("$HOME")

# Default max depth for finding shell.nix files
MAX_DEPTH=3

# Default shell command to run in nix-shell (can be overridden in config)
NIX_SHELL_COMMAND=""

# Check for required dependencies
check_dependencies() {
    local missing=()
    
    for cmd in fzf tmux nix-shell; do
        if ! command -v "$cmd" &> /dev/null; then
            missing+=("$cmd")
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "Error: Missing required dependencies: ${missing[*]}" >&2
        exit 1
    fi
}

# Load configuration
load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        # shellcheck disable=SC1090
        source "$CONFIG_FILE"
    fi
}

# Find all shell.nix files in configured paths
find_nix_shells() {
    for path in "${SEARCH_PATHS[@]}"; do
        # Expand path
        local expanded_path="${path/#\~/$HOME}"
        
        if [[ -d "$expanded_path" ]]; then
            # Find shell.nix files and output their parent directories
            find "$expanded_path" -maxdepth "$MAX_DEPTH" -type f -name "shell.nix" -printf '%h\n' 2>/dev/null
        fi
    done
}

# Create or switch to tmux session for the selected directory
open_session() {
    local selected="$1"
    
    if [[ -z "$selected" ]]; then
        exit 0
    fi
    
    # Create session name from path:
    # 1. Remove $HOME prefix
    # 2. Remove leading slash
    # 3. Replace dots with underscores (tmux doesn't like dots in session names)
    local session_name
    session_name=$(echo "$selected" | sed "s@$HOME@@; s@^/@@; s@\.@_@g")
    
    # Check if session already exists
    if tmux has-session -t="$session_name" 2>/dev/null; then
        # Session exists, switch to it
        if [[ -n "$TMUX" ]]; then
            tmux switch-client -t "$session_name"
        else
            tmux attach-session -t "$session_name"
        fi
    else
        # Create new session with nix-shell
        if [[ -n "$NIX_SHELL_COMMAND" ]]; then
            # Run nix-shell with custom command
            tmux new-session -d -s "$session_name" -c "$selected" nix-shell --run "$NIX_SHELL_COMMAND"
        else
            # Run nix-shell with default behavior
            tmux new-session -d -s "$session_name" -c "$selected" nix-shell
        fi
        
        if [[ -n "$TMUX" ]]; then
            tmux switch-client -t "$session_name"
        else
            tmux attach-session -t "$session_name"
        fi
    fi
}

# Show help
show_help() {
    cat << EOF
tmux-nix-finder - Find shell.nix files and open them in tmux sessions with nix-shell

Usage: tmux-nix-finder [OPTIONS]

Options:
    -h, --help      Show this help message
    -l, --list      List all shell.nix directories without opening

Configuration:
    Config file: $CONFIG_FILE
    
    The config file allows you to configure:
    - SEARCH_PATHS: Array of directories to search for shell.nix files
    - MAX_DEPTH: Maximum depth to search (default: 3)
    - NIX_SHELL_COMMAND: Optional command to run in nix-shell (e.g., "zsh" or "bash")

Example config:
    SEARCH_PATHS=("\$HOME/projects" "\$HOME/work")
    MAX_DEPTH=4
    NIX_SHELL_COMMAND="zsh"

Examples:
    tmux-nix-finder              # Interactive shell.nix selection
    tmux-nix-finder --list       # List all shell.nix directories

EOF
}

# Main function
main() {
    load_config
    check_dependencies
    
    # Stream shell.nix directories directly to fzf for immediate display
    local selected
    selected=$(find_nix_shells | fzf --tmux=center,100% --prompt="Select shell.nix directory: ")
    
    open_session "$selected"
}

# Parse command line arguments
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    -l|--list)
        load_config
        find_nix_shells | sort -u
        exit 0
        ;;
    "")
        main
        ;;
    *)
        echo "Error: Unknown option: $1" >&2
        show_help
        exit 1
        ;;
esac
